name: Build and Release Resume

on:
  push:
    branches: [master, main]
    paths:
      - '*.tex'
      - '.github/workflows/**'
  pull_request:
    branches: [master, main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build_latex:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v3
        with:
          root_file: resume.tex
          latexmk_use_xelatex: false
          latexmk_shell_escape: true

      - name: Rename PDF with author name
        run: mv resume.pdf Wasim_Akhtar_Resume.pdf

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: resume-pdf
          path: Wasim_Akhtar_Resume.pdf
          retention-days: 30

      - name: Commit updated PDF to repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Wasim_Akhtar_Resume.pdf
          git diff --staged --quiet || git commit -m "ðŸ“„ Auto-update resume PDF [skip ci]"
          git push

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create Release on tag
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: Wasim_Akhtar_Resume.pdf
          name: Resume ${{ steps.date.outputs.date }}
          body: |
            ðŸ“„ **Wasim Akhtar - Resume**
            
            Updated resume generated from LaTeX source.
            
            Download the PDF below.
          draft: false
          prerelease: false
